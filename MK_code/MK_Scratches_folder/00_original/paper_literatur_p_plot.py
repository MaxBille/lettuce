from matplotlib import pyplot as plt
import numpy as np
import tikzplotlib as tikz

u_0 = 0.051985464155929494

pos = []
ref = []

coords1 = [[90, 120, 57.0],
[91, 120, 57.30001437781655],
[92, 120, 57.6000287556331],
[93, 120, 57.90004313344965],
[94, 120, 58.200057511266195],
[95, 120, 58.50007188908275],
[96, 120, 58.80008626689929],
[97, 120, 59.100100644715845],
[98, 120, 59.40011502253239],
[99, 120, 59.70012940034894],
[100, 120, 60.000143778165494],
[101, 120, 60.30015815598204],
[102, 120, 60.60017253379859],
[103, 120, 60.90018691161514],
[104, 120, 61.20020128943169],
[105, 120, 61.500215667248234],
[106, 120, 61.80023004506479],
[107, 120, 62.10024442288133],
[108, 120, 62.400258800697884],
[109, 120, 62.700273178514436],
[110, 120, 63.00028755633098],
[111, 120, 63.300301934147534],
[112, 120, 63.60031631196408],
[113, 120, 63.90033068978063],
[114, 120, 64.20034506759717],
[115, 120, 64.50035944541372],
[116, 120, 64.80037382323027],
[117, 120, 65.10038820104683],
[118, 120, 65.40040257886338],
[119, 120, 65.70041695667993],
[120, 120, 66.00043133449648],
[121, 120, 65.70041695667993],
[122, 120, 65.40040257886338],
[123, 120, 65.10038820104683],
[124, 120, 64.80037382323027],
[125, 120, 64.50035944541372],
[126, 120, 64.20034506759717],
[127, 120, 63.90033068978063],
[128, 120, 63.60031631196408],
[129, 120, 63.300301934147534],
[130, 120, 63.00028755633098],
[131, 120, 62.700273178514436],
[132, 120, 62.400258800697884],
[133, 120, 62.10024442288133],
[134, 120, 61.80023004506479],
[135, 120, 61.500215667248234],
[136, 120, 61.20020128943169],
[137, 120, 60.90018691161514],
[138, 120, 60.60017253379859],
[139, 120, 60.30015815598204],
[140, 120, 60.000143778165494],
[141, 120, 59.70012940034894],
[142, 120, 59.40011502253239],
[143, 120, 59.100100644715845],
[144, 120, 58.80008626689929],
[145, 120, 58.50007188908275],
[146, 120, 58.200057511266195],
[147, 120, 57.90004313344965],
[148, 120, 57.6000287556331],
[149, 120, 57.30001437781655],
[150, 120, 57.0]]
pos.append([(x[0]-90)/60 for x in coords1[:]])

refp1 = np.genfromtxt(f'/home/martin/Ablage/p_auswertung/p_310_2_new.csv', delimiter=',')
refp2 = np.genfromtxt(f'/home/martin/Ablage/p_auswertung/p_310_3_new.csv', delimiter=',')
refp2[:, 1] = refp2[:, 1] + 0.5 / np.cos(16.7/180*np.pi)
ref1 = np.concatenate([refp1, refp2])
ref1[:, 1] = ref1[:, 1] * np.cos(16.7/180 * np.pi)
ref.append(ref1)

coords2 = [[90, 120, 57.0],
[91, 120, 57.500762697743845],
[92, 120, 58.00152539548769],
[93, 120, 58.50228809323153],
[94, 120, 59.00305079097537],
[95, 120, 59.50381348871922],
[96, 120, 60.00457618646306],
[97, 120, 60.50533888420691],
[98, 120, 61.00610158195075],
[99, 120, 61.5068642796946],
[100, 120, 62.007626977438434],
[101, 120, 62.50838967518228],
[102, 120, 63.009152372926124],
[103, 120, 63.50991507066997],
[104, 120, 64.01067776841381],
[105, 120, 64.51144046615765],
[106, 120, 65.01220316390149],
[107, 120, 65.51296586164534],
[108, 120, 66.0137285593892],
[109, 120, 66.51449125713303],
[110, 120, 67.01525395487687],
[111, 120, 67.51601665262072],
[112, 120, 68.01677935036456],
[113, 120, 68.5175420481084],
[114, 120, 69.01830474585225],
[115, 120, 69.51906744359609],
[116, 120, 70.01983014133994],
[117, 120, 70.52059283908378],
[118, 120, 71.02135553682763],
[119, 120, 71.52211823457147],
[120, 120, 72.0228809323153],
[121, 120, 71.52211823457147],
[122, 120, 71.02135553682763],
[123, 120, 70.52059283908378],
[124, 120, 70.01983014133994],
[125, 120, 69.51906744359609],
[126, 120, 69.01830474585225],
[127, 120, 68.5175420481084],
[128, 120, 68.01677935036456],
[129, 120, 67.51601665262072],
[130, 120, 67.01525395487687],
[131, 120, 66.51449125713303],
[132, 120, 66.0137285593892],
[133, 120, 65.51296586164534],
[134, 120, 65.01220316390149],
[135, 120, 64.51144046615765],
[136, 120, 64.01067776841381],
[137, 120, 63.50991507066997],
[138, 120, 63.009152372926124],
[139, 120, 62.50838967518228],
[140, 120, 62.007626977438434],
[141, 120, 61.5068642796946],
[142, 120, 61.00610158195075],
[143, 120, 60.50533888420691],
[144, 120, 60.00457618646306],
[145, 120, 59.50381348871922],
[146, 120, 59.00305079097537],
[147, 120, 58.50228809323153],
[148, 120, 58.00152539548769],
[149, 120, 57.500762697743845],
[150, 120, 57.0]]
pos.append([(x[0]-90)/60 for x in coords2[:]])

refp1 = np.genfromtxt(f'/home/martin/Ablage/p_auswertung/p_510_2_new.csv', delimiter=',')
refp2 = np.genfromtxt(f'/home/martin/Ablage/p_auswertung/p_510_3_new.csv', delimiter=',')
refp2[:, 1] = refp2[:, 1] + 0.5 / np.cos(26.6/180*np.pi)
ref2 = np.concatenate([refp1, refp2])
ref2[:, 1] = ref2[:, 1] * np.cos(26.6/180 * np.pi)
ref.append(ref2)

coords3 = [[90, 120, 57.0],
[91, 120, 57.75082123803877],
[92, 120, 58.50164247607753],
[93, 120, 59.252463714116296],
[94, 120, 60.003284952155056],
[95, 120, 60.75410619019382],
[96, 120, 61.50492742823259],
[97, 120, 62.25574866627135],
[98, 120, 63.00656990431012],
[99, 120, 63.75739114234888],
[100, 120, 64.50821238038765],
[101, 120, 65.25903361842641],
[102, 120, 66.00985485646518],
[103, 120, 66.76067609450394],
[104, 120, 67.5114973325427],
[105, 120, 68.26231857058147],
[106, 120, 69.01313980862024],
[107, 120, 69.763961046659],
[108, 120, 70.51478228469776],
[109, 120, 71.26560352273653],
[110, 120, 72.0164247607753],
[111, 120, 72.76724599881406],
[112, 120, 73.51806723685283],
[113, 120, 74.26888847489158],
[114, 120, 75.01970971293035],
[115, 120, 75.77053095096912],
[116, 120, 76.52135218900789],
[117, 120, 77.27217342704665],
[118, 120, 78.0229946650854],
[119, 120, 78.77381590312417],
[120, 120, 79.52463714116294],
[121, 120, 78.77381590312417],
[122, 120, 78.0229946650854],
[123, 120, 77.27217342704665],
[124, 120, 76.52135218900789],
[125, 120, 75.77053095096912],
[126, 120, 75.01970971293035],
[127, 120, 74.26888847489158],
[128, 120, 73.51806723685283],
[129, 120, 72.76724599881406],
[130, 120, 72.0164247607753],
[131, 120, 71.26560352273653],
[132, 120, 70.51478228469776],
[133, 120, 69.763961046659],
[134, 120, 69.01313980862024],
[135, 120, 68.26231857058147],
[136, 120, 67.5114973325427],
[137, 120, 66.76067609450394],
[138, 120, 66.00985485646518],
[139, 120, 65.25903361842641],
[140, 120, 64.50821238038765],
[141, 120, 63.75739114234888],
[142, 120, 63.00656990431012],
[143, 120, 62.25574866627135],
[144, 120, 61.50492742823259],
[145, 120, 60.75410619019382],
[146, 120, 60.003284952155056],
[147, 120, 59.252463714116296],
[148, 120, 58.50164247607753],
[149, 120, 57.75082123803877],
[150, 120, 57.0]]
pos.append([(x[0]-90)/60 for x in coords3[:]])

refp1 = np.genfromtxt(f'/home/martin/Ablage/p_auswertung/p_710_2_new.csv', delimiter=',')
refp2 = np.genfromtxt(f'/home/martin/Ablage/p_auswertung/p_710_3_new.csv', delimiter=',')
refp2[:, 1] = refp2[:, 1] + 0.5 / np.cos(36.9/180*np.pi)
ref3 = np.concatenate([refp1, refp2])
ref3[:, 1] = ref3[:, 1] * np.cos(36.9/180 * np.pi)
ref.append(ref3)

# K_N
ins = "1_3"

p = []

if ins == "1_3":
    p.append(np.load("/home/martin/Ablage/p_auswertung/p_verify_RefVel_1_3_16.7deg.npy")/(0.5 * 1.225 * u_0**2))
    p.append(np.load("/home/martin/Ablage/p_auswertung/p_verify_RefVel_1_3_26.6deg.npy")/(0.5 * 1.225 * u_0**2))
    p.append(np.load("/home/martin/Ablage/p_auswertung/p_verify_RefVel_1_3_36.9deg.npy")/(0.5 * 1.225 * u_0**2))
elif ins == "1.75_2":
    p.append(np.load("/home/martin/Ablage/p_auswertung/p_verify_RefVel_1.75_2_16.7deg.npy")/(0.5 * 1.225 * u_0**2))
    p.append(np.load("/home/martin/Ablage/p_auswertung/p_verify_RefVel_1.75_2_26.6deg.npy")/(0.5 * 1.225 * u_0**2))
    p.append(np.load("/home/martin/Ablage/p_auswertung/p_verify_RefVel_1.75_2_36.9deg.npy")/(0.5 * 1.225 * u_0**2))
elif ins == "1_4":
    p.append(np.load("/home/martin/Ablage/p_auswertung/p_verify_RefVel_1_4_16.7deg.npy")/(0.5 * 1.225 * u_0**2))
    p.append(np.load("/home/martin/Ablage/p_auswertung/p_verify_RefVel_1_4_26.6deg.npy")/(0.5 * 1.225 * u_0**2))
    p.append(np.load("/home/martin/Ablage/p_auswertung/p_verify_RefVel_1_4_36.9deg.npy")/(0.5 * 1.225 * u_0**2))

txt3 = ["16.7", "26.6", "36.9"]
txt = ["16", "26", "36"]

def calculate_errors_p(p, p_pos, ref, start=0, end=-1):
    p = [press[start:end, ...] for press in p]

    rel_error_ref = np.zeros([3, len(ref[0][:, 1])])
    rel_error_range = np.zeros([3, len(ref[0][:, 1])])
    abs_error = np.zeros([3, len(ref[0][:, 1])])
    corr = np.zeros(3)

    min = np.zeros(3)
    max = np.zeros(3)

    for i in range(0,3):
        p[i] = np.mean(p[i][:, 2:], axis=0)
        min[i] = np.min(p[i])
        max[i] = np.max(p[i])

    val_range = np.max(max) - np.min(min)

    for i in range(0, 3):
        values = []
        for j in range(len(ref[i])):
            pos = np.where((np.abs(p_pos[i] - ref[i][j, 1]) == np.min(np.abs(p_pos[i] - ref[i][j, 1]))))
            values.append(p[i][pos[0]])
            abs_error[i, j] = np.abs((values[j] - ref[i][j, 0]))
            rel_error_ref[i,j] = np.abs((values[j] - ref[i][j, 0])/ref[i][j, 0])
            rel_error_range[i, j] = np.abs((values[j] - ref[i][j, 0]) / val_range)
        corr[i] = np.corrcoef(np.array(values).squeeze(), ref[i][:, 0])[0, 1]
        print(f"Error results: {txt3[i]}°: abs: {np.mean(abs_error[i, :])}, rel_ref: {np.mean(rel_error_ref[i, :])}, rel_range: {np.mean(rel_error_range[i, :])}, range: {val_range}, correlation : {corr[i]}")

calculate_errors_p(p, pos, ref, 20000)

if 1:

    for i in range(0,3):

        plt.figure()
        plt.plot(ref[i][:, 1], ref[i][:, 0], label="reference", marker="o", color="gray", linestyle="None")
        plt.plot(pos[i], np.mean(p[i][100000:, 2:], axis=0), label="simulation", color="black")

        plt.grid()
        plt.xlabel("position along roof surface")
        plt.ylabel("$C_p$")
        plt.legend()
        plt.title(f"{txt3[i]}° roof pitch")
        tikz.clean_figure()
        tikz.save(f"literatur_p_{txt[i]}.tikz")
        plt.show()